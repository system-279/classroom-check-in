# 要件

## 背景
Google Classroom 上の講座について、受講者の入退室（IN/OUT）と滞在時間を管理したい。
テスト実施時は提出時間をOUTの参考にできるが、動画視聴のみの場合もあるため、手動/補助的にOUTを入力できる仕組みが必要。
Meetは使わない可能性があるため、動画視聴の計測を主軸にする。

## 用語
- IN: 講座への参加開始
- OUT: 講座への参加終了
- セッション: 1回のINからOUTまでの期間
- 講座: Google Classroom の Course を指す

## 機能要件
- MUST: Googleアカウントでログインできる（Firebase Authentication + Googleソーシャルログイン）（ADR-0016）
- MUST: 講座単位でIN/OUT時刻を記録できる
- MUST: 入室ボタン押下でIN打刻し、対象のGoogle Classroomへ遷移できる
- MUST: 入室前に講座を選択しないとINできない
- MUST: 講座選択に応じて遷移先リンクを動的に切り替えられる
- MUST: 1人の受講者が1講座で複数セッションを持てる
- MUST: セッションの開始/終了時刻と滞在時間を保持する
- MUST: OUTが未入力の場合は「進行中セッション」として保持する
- MUST: IN/OUTの根拠（ソース）を保持する（動画/手動/テスト等）
- MUST: 管理者が管理画面で講座を登録し、講座選択に利用する（ADR-0014: Classroom API連携は廃止）
- MUST: 管理者が講座名・Classroom URL・受講者を手動で登録できる
- MUST: 対象講座の表示/非表示を管理者が設定できる
- SHOULD: 受講者が手動でOUTを入力できる（動画視聴のみのケース対応）
- SHOULD: 過去日時を指定してOUTを補正できる
- SHOULD: 教員/管理者が手動補正できる
- SHOULD: テスト提出時間をOUTの参考値として取り込める
- SHOULD: 講座別・受講者別の滞在時間集計ができる
- SHOULD: 取得可能なClassroom情報/動画視聴情報を一覧・グラフ化する
- SHOULD: OUT忘れをメール等で通知できる
- SHOULD: OUT忘れ通知ポリシーを管理者が設定できる
- SHOULD: 対象ユーザーごとに通知ポリシーを上書きできる
- SHOULD: ブラウザタブの離脱/閉鎖を検知した場合に退室打刻を提案できる
- SHOULD: 一定間隔で退室打刻の提案を表示できる
- COULD: IN/OUT時刻の推定信頼度を持つ（自動推定時）
 - COULD: 受講者には参加中の講座のみを表示する（難しければ対象講座全体）

## 管理機能
- MUST: 管理者ロールのみが通知ポリシーを編集できる
- MUST: 受講者は自分の通知設定を閲覧のみ可能（要検討）
- MUST: 管理画面で講座を登録し、有効/表示を切り替えできる
- MUST: 管理画面でIN/OUTの補正（手動クローズ）を行える
- MUST: 管理画面でアクセス許可リスト（AllowedEmails）を管理できる（ADR-0017）
- SHOULD: 管理画面でフォームIDの登録・紐づけを行える
- SHOULD: 管理画面で通知ポリシーの上書き（講座/ユーザー）を設定できる

## クライアント挙動
- MUST: 入室後は一定間隔で心拍（heartbeat）を送信できる
- SHOULD: タブが非表示/終了した場合に終了提案を表示する（可能な範囲で）

## 動画視聴の要件（スコープ外）
> **注**: 動画プレイヤー連携は実装しない（ADR-0015参照）。以下は参考として残す。

- ~~MUST: 動画視聴の開始/終了/再生位置/再生速度を取得し、視聴区間を記録する~~
- ~~MUST: 再生速度の変更を検知し、1x以外の区間は無効化または別扱いにする~~
- ~~MUST: 先頭から最後まで視聴したかを判定できる（必要なら視聴割合の閾値を設定）~~
- ~~SHOULD: シーク/スキップ/タブ非表示などを検知し、信頼度に反映する~~
- ~~SHOULD: 外部動画視聴は埋め込みプレイヤー経由に限定する~~
- ~~COULD: 動画ごとに必須視聴割合/速度ポリシーを設定できる~~

## 非機能要件
- セキュリティ: Firebase Authentication認証、管理者権限の適切な管理、監査ログ保管
- プライバシー: 必要最小限のデータのみ保存、保存期間の定義
- 可用性: 毎日/毎週のバッチ集計が停止しても復旧可能
- 正確性: セッション開始/終了の判定根拠を残し、後から再計算できる
- タイムゾーン: すべての記録をUTCで保持し、表示時に変換
- 計測精度: フロント側イベントの信頼性を前提に、不正検知の余地を残す

## 主要ユースケース
- 教員が講座ごとの出席/滞在時間を確認する
- 受講者が動画を視聴し、視聴完了をもってOUTを確定する
- 受講者が動画視聴のみの場合に手動でOUTを入力する
- テスト実施時、提出時間をOUT推定として自動記録する

## 例外・境界条件
- INが複数回連続した場合は既存openセッションを返す（新規作成しない）
- OUTが先に記録された場合は手動補正フローに回す
- 同時に複数講座のセッションは禁止（別講座でIN時にエラー）（ADR-0023）
- 48時間経過したopenセッションは自動クローズ（ADR-0020）
