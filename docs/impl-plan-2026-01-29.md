# 実装計画: 安定したAI駆動開発の継続

## 現状分析

### 実装済み（requirements.md MUST）
| 項目 | 状態 | ADR |
|------|------|-----|
| マルチテナント | ✅ | ADR-0018/0019 |
| Firebase認証 + Googleログイン | ✅ | ADR-0016 |
| 講座単位IN/OUT記録 | ✅ | - |
| 管理画面（講座/ユーザー/受講登録） | ✅ | - |
| 通知ポリシー管理 | ✅ | - |
| アクセス許可リスト | ✅ | ADR-0017 |
| heartbeat継続 | ✅ | ADR-0022 |
| スーパー管理者 | ✅ | ADR-0024 |

### 実装済み（SHOULD）
| 項目 | 状態 |
|------|------|
| OUT忘れ通知 | ✅ |
| セルフチェックアウト | ✅ |
| 必要視聴時間チェック | ✅ |
| 48時間自動クローズ | ✅ (ADR-0020) |

### テストカバレッジ
| サービス | ユニットテスト | 備考 |
|----------|---------------|------|
| API | 222件 | middleware, routes, datasource |
| Notification | 20件 | session-detector, auto-closer |
| E2E | 54件 | Playwright (CI実行) |

---

## 改善計画（優先度順）

### Phase 1: 品質基盤の強化（推奨）

#### 1.1 統合テストの追加
**目的**: API→Firestore→レスポンスの一連のフローを検証
**対象**:
- セッション作成→更新→クローズのフロー
- テナント作成→初期データ確認
**工数**: 小（1-2時間）
**テスト駆動**: REDから開始

#### 1.2 エラーハンドリングの統一
**目的**: 全APIで一貫したエラーレスポンス形式
**対象**:
- グローバルエラーハンドラーの整備
- エラーコード体系の定義
- クライアント側のエラー表示統一
**工数**: 中（2-3時間）
**ADR**: 必要に応じて作成

#### 1.3 ログ・監査機能
**目的**: 運用時のトラブルシューティング対応
**対象**:
- 構造化ログ（JSON形式）
- 重要操作の監査ログ（テナント作成、ロール変更等）
**工数**: 中（2-3時間）
**ADR**: ADR-0025として記録

---

### Phase 2: UX改善

#### 2.1 統計ダッシュボードの充実
**目的**: 講座別・受講者別の滞在時間を可視化
**対象**:
- 管理画面ダッシュボードに集計グラフ追加
- CSVエクスポート機能
**工数**: 中〜大（3-5時間）
**テスト駆動**: UIテストをE2Eで追加

#### 2.2 レスポンシブ対応の改善
**目的**: モバイルでの操作性向上
**対象**:
- 受講者画面（IN/OUT操作）
- 管理画面（基本操作）
**工数**: 中（2-3時間）

---

### Phase 3: 運用改善

#### 3.1 デプロイ自動化の強化
**目的**: CI/CDパイプラインの信頼性向上
**対象**:
- E2Eテストのステージング環境実行
- デプロイ後のヘルスチェック
**工数**: 中（2-3時間）

#### 3.2 パフォーマンス監視
**目的**: レイテンシ・エラー率の可視化
**対象**:
- Cloud Monitoringダッシュボード設定
- アラート設定
**工数**: 小（1時間）

---

## AI駆動開発プロセス

### 各フェーズの進め方

```
1. 計画作成（このドキュメント）
   ↓
2. テスト作成（RED）
   - 期待する振る舞いを先に定義
   - 失敗するテストを確認
   ↓
3. 最小実装（GREEN）
   - テストを通す最小限のコード
   - 完璧を目指さない
   ↓
4. リファクタリング（REFACTOR）
   - DRY原則
   - 読みやすさ優先
   ↓
5. /safe-refactor 実行
   - 3ファイル以上の変更時
   ↓
6. コミット・PR作成
   - 小さな単位でこまめに
   ↓
7. ドキュメント更新
   - ADR追記（重要な判断時）
   - CLAUDE.md同期
```

### 失敗時のエスカレーション

```
1回目: 自己修正
  ↓ 失敗
2回目: 原因分析深掘り
  ↓ 失敗
3回目: /codex (GPT委譲) または人間に報告
```

---

## 推奨する次のアクション

### 即座に着手可能（Phase 1.1）
1. **統合テストの追加** - 品質基盤として最優先
   - `services/api/src/__tests__/integration/` ディレクトリ作成
   - セッションフローの統合テスト作成
   - テナント作成の統合テスト作成

### ユーザー判断が必要
- Phase 2以降の優先度
- 機能追加 vs 品質改善のバランス
- デプロイ・リリース計画

---

## 選択肢

| オプション | 内容 | 工数 |
|-----------|------|------|
| A | Phase 1.1のみ（統合テスト追加） | 1-2時間 |
| B | Phase 1全体（品質基盤強化） | 5-8時間 |
| C | Phase 1 + 2.1（統計ダッシュボード） | 8-13時間 |
| D | 別の優先事項を指定 | - |

どのオプションで進めますか？
