# 重要な設計判断（ADR）

## ADR-0001: IN/OUT取得の一次ソース
- 状態: 採用
- 背景: Classroom API単体では入退室情報が取れない
- 判断: 動画プレイヤーの視聴イベントを一次ソースとして扱う
- 影響: 埋め込みプレイヤー前提となり、外部視聴は計測不可

## ADR-0002: OUT未確定セッションの扱い
- 状態: 採用
- 背景: 動画視聴/手動入力ではOUTが遅延する
- 判断: end_time=null の open セッションを許容し、後で補完
- 影響: 集計時にopenセッションの扱いを決める必要

## ADR-0003: 再生速度の扱い
- 状態: 採用
- 背景: 速度変更やシークによる実質視聴の担保が必要
- 判断: 1x以外の視聴区間は無効または別扱いにし、完走判定に含めない
- 影響: プレイヤー側での速度監視と、判定ロジックの整備が必要

## ADR-0004: 入退室のUI提供
- 状態: 採用
- 背景: Classroom自体に入退室ログ取得APIがないため代替が必要
- 判断: 自社WebアプリでIN/OUTボタンを提供し、手動入力を一次ソースとする
- 影響: ユーザー体験と通知/補正フローの設計が重要

## ADR-0005: テスト（Forms）連携の方針
- 状態: 採用
- 背景: Classroom課題がGoogleフォームの場合、提出時間をOUT補助に使いたい
- 判断: フォームIDは管理画面で手動登録し、Forms APIで回答時刻を取得する
- 影響: 手動設定の運用が必要、誤設定時の検出が必要

## ADR-0006: 講座一覧の取得と選択
- 状態: 採用
- 背景: 入室前に講座選択を必須にしたい
- 判断: Classroom APIで講座一覧を取得し、管理者が対象講座をCourse IDで指定する
- 影響: Classroom APIの権限設計と同期運用が必要

## ADR-0007: 対象講座の表示制御
- 状態: 採用
- 背景: 対象講座の中でも表示/非表示を制御したい
- 判断: CourseTargetにvisibleフラグを追加し、UI表示を管理者が制御する
- 影響: 管理画面と同期の整合性が必要

## ADR-0008: 講座同期の範囲
- 状態: 採用
- 背景: Classroomの「親ID」で一括指定したいが、APIはCourse単位
- 判断: ドメイン全体の講座一覧を同期し、管理画面で対象講座を選別する
- 影響: 取得件数に応じた同期頻度/コストの調整が必要

## ADR-0009: 基本アーキテクチャ
- 状態: 採用
- 背景: 入退室/講座同期/通知/動画計測をGCPで安定運用したい
- 判断: Cloud Run中心（Ingestion/API/Event/Notification/Session）+ Firestore/BigQuery + Scheduler/Tasksを採用
- 影響: バッチとリアルタイムの二系統運用、IAM設計が重要

## ADR-0010: 技術スタックとバージョン
- 状態: 採用
- 背景: 実装とドキュメントの一致を保証する必要がある
- 判断: `docs/tech-stack.md` に記載の安定版を採用し、実装依存と一致させる
- 影響: 依存更新時はドキュメントの更新が必須

## ADR-0011: モノレポ構成
- 状態: 採用
- 背景: API/バッチ/通知/フロントを一括で管理したい
- 判断: npm workspaces で `services/*` と `web/` を管理する
- 影響: ルートの依存管理とCI設計が必要

## ADR-0012: 連続INの扱い
- 状態: 採用
- 背景: 連続してINが押される可能性がある
- 判断: 既存openセッションがあればそれを返し、新規作成しない
- 影響: クライアントは同一セッションを再利用する必要がある

## ADR-0013: Classroom同期の認証方式
- 状態: 採用
- 背景: ドメイン全体の講座一覧/参加者を取得する必要がある
- 判断: サービスアカウント + ドメインワイドデリゲーション（管理者subject）を前提とする
- 影響: `GOOGLE_WORKSPACE_ADMIN_SUBJECT` と認可スコープの設定が必須
